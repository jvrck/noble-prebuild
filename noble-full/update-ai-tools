#!/bin/bash

# update-ai-tools - Update all AI CLI tools
# This script updates claude-code, gemini-cli, qwen-code, and codex-cli

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Function to update a package
update_package() {
    local package_name=$1
    local display_name=$2

    print_status "Updating $display_name..."

    if npm update -g "$package_name" 2>/dev/null; then
        print_status "✓ $display_name updated successfully"
    else
        print_error "✗ Failed to update $display_name"
        return 1
    fi
}

# Main script
main() {
    echo "========================================="
    echo "    AI CLI Tools Updater"
    echo "========================================="
    echo ""

    # Check if npm is available
    if ! command -v npm &> /dev/null; then
        print_error "npm is not installed or not in PATH"
        exit 1
    fi

    print_status "Starting updates..."
    echo ""

    # Track failures
    failed_updates=()

    # Update each tool
    if ! update_package "@anthropic-ai/claude-code" "Claude Code CLI"; then
        failed_updates+=("Claude Code CLI")
    fi
    echo ""

    if ! update_package "@google/gemini-cli" "Gemini CLI"; then
        failed_updates+=("Gemini CLI")
    fi
    echo ""

    if ! update_package "@qwen-code/qwen-code" "Qwen Code CLI"; then
        failed_updates+=("Qwen Code CLI")
    fi
    echo ""

    if ! update_package "@openai/codex" "Codex CLI"; then
        failed_updates+=("Codex CLI")
    fi
    echo ""

    # Summary
    echo "========================================="
    if [ ${#failed_updates[@]} -eq 0 ]; then
        print_status "All AI tools updated successfully! ✓"
    else
        print_warning "Updates completed with some failures:"
        for tool in "${failed_updates[@]}"; do
            echo "  - $tool"
        done
    fi
    echo "========================================="

    # Show installed versions
    echo ""
    print_status "Current versions:"
    npm list -g --depth=0 2>/dev/null | grep -E "@anthropic-ai/claude-code|@google/gemini-cli|@qwen-code/qwen-code|@openai/codex" || true
}

# Run main function
main "$@"